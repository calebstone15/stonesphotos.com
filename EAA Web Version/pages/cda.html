<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CdA Calculator - ERPL</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.2/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- Papa Parse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <div class="page-wrapper">
        <!-- Navigation -->
        <nav class="nav-header">
            <div class="container nav-content">
                <a href="../index.html">
                    <img src="../assets/ERPL Logo Downscaled.png" alt="ERPL Logo" class="nav-logo">
                </a>
                <a href="../index.html" class="nav-home-btn">
                    <span>üè†</span>
                    <span>Home</span>
                </a>
            </div>
        </nav>

        <main class="main-content">
            <div class="container">
                <div class="two-column-layout">
                    <!-- LEFT PANEL - CdA Calculator -->
                    <div class="panel fade-in">
                        <div class="panel-header">
                            <h2 class="panel-title">üî¢ CdA Calculator</h2>
                        </div>
                        <div class="panel-content">
                            <!-- Equation -->
                            <div class="equation-box">
                                <div class="equation-main">CdA = ·πÅ / ‚àö(2œÅŒîP)</div>
                                <div class="equation-desc">·πÅ=flow rate, œÅ=density, ŒîP=pressure drop</div>
                            </div>

                            <!-- 1. Load CSV -->
                            <div class="section">
                                <div class="section-title">
                                    <span class="section-number">1</span>
                                    Load CSV Data
                                </div>
                                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                                    <div class="file-input-wrapper">
                                        <input type="file" id="cdaCsvInput" accept=".csv" class="file-input"
                                            onchange="cdaLoadCSV(this)">
                                        <label class="file-input-label">
                                            <span>üìÅ</span>
                                            <span>Load CSV</span>
                                        </label>
                                    </div>
                                    <span id="cdaFileLabel" class="file-name">No file loaded</span>
                                </div>
                            </div>

                            <!-- 2. Select Columns -->
                            <div class="section">
                                <div class="section-title">
                                    <span class="section-number">2</span>
                                    Select Columns
                                </div>
                                <div class="grid-2" style="gap: var(--spacing-md);">
                                    <div class="form-group">
                                        <label class="form-label">Time Column:</label>
                                        <select id="cdaTimeSelect" class="form-select"
                                            onchange="cdaUpdateColumn('time')"></select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Pressure Column (PSI):</label>
                                        <select id="cdaPressureSelect" class="form-select"
                                            onchange="cdaUpdateColumn('pressure')"></select>
                                    </div>
                                    <div class="form-group" style="grid-column: span 2;">
                                        <label class="form-label">Tank Weight Column (lbs):</label>
                                        <select id="cdaWeightSelect" class="form-select"
                                            onchange="cdaUpdateColumn('weight')"></select>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Select Time Range -->
                            <div class="section">
                                <div class="section-title">
                                    <span class="section-number">3</span>
                                    Select Time Range
                                </div>
                                <button class="btn btn-secondary" onclick="openTimeSelectionPlot()">
                                    üìä Open Plot Window to Select Times
                                </button>
                                <div style="display: flex; gap: var(--spacing-xl); margin-top: var(--spacing-md);">
                                    <div>
                                        <span style="color: var(--text-muted);">Start:</span>
                                        <span id="cdaStartTime" style="font-weight: 700; color: var(--error);">--</span>
                                    </div>
                                    <div>
                                        <span style="color: var(--text-muted);">End:</span>
                                        <span id="cdaEndTime" style="font-weight: 700; color: var(--error);">--</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. Input Parameters -->
                            <div class="section">
                                <div class="section-title">
                                    <span class="section-number">4</span>
                                    Input Parameters
                                </div>
                                <div class="grid-2" style="gap: var(--spacing-md);">
                                    <div class="form-group">
                                        <label class="form-label">P_high (PSI):</label>
                                        <div style="display: flex; gap: var(--spacing-sm);">
                                            <input type="number" id="pHighInput" class="form-input" step="any">
                                            <button class="btn btn-secondary" onclick="useAvgPressure('high')">Use
                                                Avg</button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">P_low (PSI):</label>
                                        <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                                            <input type="number" id="pLowInput" class="form-input" value="14.7"
                                                step="any" style="flex: 1;">
                                            <button class="btn btn-secondary"
                                                onclick="setAmbientPressure()">Ambient</button>
                                            <button class="btn btn-secondary" onclick="selectPLowFromCSV()">From
                                                CSV</button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Density œÅ (kg/m¬≥):</label>
                                        <input type="number" id="densityInput" class="form-input" value="1000"
                                            step="any">
                                        <span style="font-size: 0.85rem; color: var(--text-muted);">(water‚âà1000,
                                            LOX‚âà1141)</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Calculated ·πÅ (kg/s):</label>
                                        <div id="calculatedMdot"
                                            style="font-weight: 700; color: var(--error); font-size: 1.1rem;">--</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 5. Result -->
                            <div class="section">
                                <div class="section-title">
                                    <span class="section-number">5</span>
                                    Result
                                </div>
                                <button class="btn btn-primary btn-large" onclick="calculateCdA()" style="width: 100%;">
                                    Calculate CdA
                                </button>
                                <div class="result-display" id="cdaResultDisplay" style="display: none;">
                                    <div class="result-label">CdA</div>
                                    <div class="result-value" id="cdaResultValue">--</div>
                                    <div class="result-unit" id="cdaResultUnit">m¬≤</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT PANEL - Set Pressure Calculator -->
                    <div class="panel fade-in" style="animation-delay: 0.1s;">
                        <div class="panel-header">
                            <h2 class="panel-title">‚öôÔ∏è Set Pressure Calculator</h2>
                        </div>
                        <div class="panel-content">
                            <!-- Equation -->
                            <div class="equation-box">
                                <div class="equation-main">P_set = ((·πÅ/CdA)¬≤)/(2œÅ) + P_manifold</div>
                                <div class="equation-desc">Calculates required tank pressure for target flow rate</div>
                            </div>

                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: var(--spacing-lg);">
                                Use CdA value from left panel, or enter manually:
                            </p>

                            <!-- Inputs -->
                            <div class="section">
                                <div class="section-title">Inputs</div>

                                <div class="form-group">
                                    <label class="form-label">CdA (m¬≤):</label>
                                    <div style="display: flex; gap: var(--spacing-sm);">
                                        <input type="number" id="setpointCdaInput" class="form-input" step="any">
                                        <button class="btn btn-secondary" onclick="copyCalculatedCdA()">‚Üê Use
                                            Calculated</button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Target ·πÅ (kg/s):</label>
                                    <div style="display: flex; gap: var(--spacing-sm);">
                                        <input type="number" id="setpointMdotInput" class="form-input" step="any">
                                        <button class="btn btn-secondary" onclick="copyCalculatedMdot()">‚Üê Use
                                            Calculated</button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Density œÅ (kg/m¬≥):</label>
                                    <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                                        <input type="number" id="setpointDensityInput" class="form-input" value="1000"
                                            step="any" style="flex: 1;">
                                        <button class="btn btn-secondary"
                                            onclick="setDensityPreset(1000)">Water</button>
                                        <button class="btn btn-secondary" onclick="setDensityPreset(1141)">LOX</button>
                                        <button class="btn btn-secondary" onclick="setDensityPreset(820)">RP-1</button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Manifold P (PSI):</label>
                                    <input type="number" id="manifoldPressureInput" class="form-input" value="500"
                                        step="any">
                                    <span style="font-size: 0.85rem; color: var(--text-muted);">(downstream
                                        pressure)</span>
                                </div>
                            </div>

                            <!-- Calculate Button -->
                            <button class="btn btn-primary btn-large" onclick="calculateSetPressure()"
                                style="width: 100%; margin-top: var(--spacing-md);">
                                Calculate Required Set Pressure
                            </button>

                            <!-- Result -->
                            <div class="result-display" id="setpointResultDisplay"
                                style="display: none; margin-top: var(--spacing-lg);">
                                <div class="result-label">Required Set Pressure</div>
                                <div class="result-value" id="setpointResultPSI">--</div>
                                <div class="result-unit">PSI</div>
                                <div id="setpointResultPa"
                                    style="color: var(--text-muted); margin-top: var(--spacing-sm);">-- Pa</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Time Selection Plot Modal -->
    <div id="timeSelectionModal" class="modal-overlay">
        <div class="modal" style="width: 95%; max-width: 1200px; height: 85vh;">
            <div class="modal-header">
                <h3 class="modal-title">Select Time Range</h3>
                <button class="modal-close" onclick="closeTimeSelectionModal()">√ó</button>
            </div>
            <div class="modal-body" style="height: calc(100% - 140px); display: flex; flex-direction: column;">
                <p style="color: var(--text-muted); margin-bottom: var(--spacing-md);">
                    Click on the plot twice: First click = START, second click = END. Then click 'Confirm Selection' to
                    use these values.
                </p>

                <div style="display: flex; gap: var(--spacing-xl); margin-bottom: var(--spacing-md);">
                    <div>
                        <span>Start Time:</span>
                        <span id="plotStartLabel"
                            style="font-weight: 700; color: var(--success); margin-left: var(--spacing-sm);">Click on
                            plot...</span>
                    </div>
                    <div>
                        <span>End Time:</span>
                        <span id="plotEndLabel"
                            style="font-weight: 700; color: var(--error); margin-left: var(--spacing-sm);">--</span>
                    </div>
                    <button class="btn btn-secondary" onclick="resetTimeSelection()">Reset</button>
                </div>

                <div class="chart-container" style="flex: 1; min-height: 0;">
                    <canvas id="timeSelectionCanvas"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTimeSelectionModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmTimeBtn" onclick="confirmTimeSelection()" disabled>Confirm
                    Selection</button>
            </div>
        </div>
    </div>

    <!-- P_low Column Selection Modal -->
    <div id="pLowColumnModal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Select P_low Column</h3>
                <button class="modal-close" onclick="ModalManager.close('pLowColumnModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: var(--spacing-md);">
                    Select the pressure column for P_low:
                </p>
                <select id="pLowColumnSelect" class="form-select"></select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="ModalManager.close('pLowColumnModal')">Cancel</button>
                <button class="btn btn-primary" onclick="applyPLowColumn()">Use Average</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/utils.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/cda-calculator.js"></script>
</body>

</html>